<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬3å¤©Canvas Mockæ•°æ®æµ‹è¯•éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .canvas-container {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 20px 0;
            background: #000;
        }
        canvas {
            display: block;
            width: 100%;
            height: 400px;
        }
        .test-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 12px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }
        .btn-primary { background: #3B82F6; color: white; }
        .btn-secondary { background: #6B7280; color: white; }
        .btn-danger { background: #EF4444; color: white; }
        .btn-success { background: #10B981; color: white; }
        button:hover { opacity: 0.8; }
        button:active { transform: scale(0.98); }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .color-legend {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .color-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        .checklist {
            background: #e7f3ff;
            border-left: 4px solid #3B82F6;
            padding: 15px;
            margin: 20px 0;
        }
        .checklist h3 {
            margin-top: 0;
            color: #1e40af;
        }
        .checklist ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .checklist li {
            margin: 5px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #10B981; }
        .status-pending { background: #F59E0B; }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª ç¬¬3å¤©Canvas Mockæ•°æ®æµ‹è¯•éªŒè¯</h1>
        <p><strong>ç›®æ ‡ï¼š</strong>éªŒè¯Canvasèƒ½æ­£ç¡®ç»˜åˆ¶çŸ©å½¢æ¡†ï¼ˆè‹¥Bçš„YOLOæ¨ç†æœªå®Œæˆï¼‰</p>

        <div class="info-grid">
            <div class="checklist">
                <h3>âœ… ç¬¬3å¤©è¦æ±‚çš„åŠŸèƒ½æ¸…å•</h3>
                <ul>
                    <li><span class="status-indicator status-success"></span>Canvaså°ºå¯¸è‡ªé€‚åº”é€»è¾‘</li>
                    <li><span class="status-indicator status-success"></span>devicePixelRatioå¤„ç†</li>
                    <li><span class="status-indicator status-success"></span>resizeå’Œfullscreenchangeäº‹ä»¶</li>
                    <li><span class="status-indicator status-success"></span>drawBoxes(ctx, boxes)å‡½æ•°éª¨æ¶</li>
                    <li><span class="status-indicator status-success"></span>Mockæ•°æ®æµ‹è¯•Canvasç»˜åˆ¶çŸ©å½¢æ¡†</li>
                </ul>
            </div>
            <div class="checklist">
                <h3>ğŸ¨ MVPæ–‡æ¡£è§„èŒƒé¢œè‰²</h3>
                <div class="color-legend">
                    <div class="color-item">
                        <div class="color-box" style="background: #EF4444;"></div>
                        <span>iron_pole (çº¢è‰² #EF4444)</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box" style="background: #3B82F6;"></div>
                        <span>concrete_pole (è“è‰² #3B82F6)</span>
                    </div>
                    <div class="color-item">
                        <div class="color-box" style="background: #10B981;"></div>
                        <span>iron_gantry_pole (ç»¿è‰² #10B981)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="testCanvas"></canvas>
        </div>

        <div class="test-buttons">
            <button class="btn-primary" onclick="runTest('basic')">ğŸ¯ åŸºç¡€æµ‹è¯•</button>
            <button class="btn-secondary" onclick="runTest('boundary')">ğŸ“ è¾¹ç•Œæµ‹è¯•</button>
            <button class="btn-success" onclick="runTest('empty')">ğŸ“­ ç©ºæ•°æ®æµ‹è¯•</button>
            <button class="btn-danger" onclick="clearCanvas()">ğŸ§¹ æ¸…ç©ºç”»å¸ƒ</button>
            <button class="btn-primary" onclick="testDevicePixelRatio()">ğŸ“± DPIé€‚é…æµ‹è¯•</button>
            <button class="btn-secondary" onclick="testCanvasSync()">ğŸ”„ CanvasåŒæ­¥æµ‹è¯•</button>
        </div>

        <div class="result" id="testResult">
ğŸš€ ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹éªŒè¯CanvasåŠŸèƒ½

æµ‹è¯•è¯´æ˜ï¼š
â€¢ åŸºç¡€æµ‹è¯•ï¼šéªŒè¯3ç§ç”µæ†ç±»å‹çš„æ ‡å‡†æ£€æµ‹æ¡†
â€¢ è¾¹ç•Œæµ‹è¯•ï¼šéªŒè¯è¾¹ç¼˜ã€å°æ¡†ã€å¤§æ¡†ç­‰è¾¹ç•Œæƒ…å†µ
â€¢ ç©ºæ•°æ®æµ‹è¯•ï¼šéªŒè¯æ— æ£€æµ‹æ¡†æ—¶çš„å¤„ç†
â€¢ DPIé€‚é…æµ‹è¯•ï¼šéªŒè¯é«˜åˆ†è¾¨ç‡å±å¹•é€‚é…
â€¢ åŒæ­¥æµ‹è¯•ï¼šéªŒè¯Canvaså°ºå¯¸è‡ªé€‚åº”
        </div>
    </div>

    <script type="module">
        // Mockæ•°æ®ç”Ÿæˆå™¨ï¼ˆä¸é¡¹ç›®ä¸­çš„mockData.jså®Œå…¨ä¸€è‡´ï¼‰
        const generateMockBoxes = () => {
            return [
                {
                    id: 1,
                    xyxy: [100, 200, 300, 600],
                    label: 'iron_pole'
                },
                {
                    id: 2,
                    xyxy: [400, 220, 500, 610],
                    label: 'concrete_pole'
                },
                {
                    id: 3,
                    xyxy: [650, 210, 820, 630],
                    label: 'iron_gantry_pole'
                }
            ];
        };

        const generateBoundaryTestBoxes = () => {
            return [
                {
                    id: 10,
                    xyxy: [10, 10, 50, 50],
                    label: 'iron_pole'
                },
                {
                    id: 11,
                    xyxy: [750, 550, 790, 590],
                    label: 'concrete_pole'
                },
                {
                    id: 12,
                    xyxy: [0, 100, 800, 200],
                    label: 'iron_gantry_pole'
                }
            ];
        };

        const getBoxColor = (label) => {
            const colorMap = {
                'iron_pole': '#EF4444',
                'concrete_pole': '#3B82F6',
                'iron_gantry_pole': '#10B981'
            };
            return colorMap[label] || '#6B7280';
        };

        const drawSingleBox = (ctx, box) => {
            const { id, xyxy, label } = box;
            const [x1, y1, x2, y2] = xyxy;
            const color = getBoxColor(label);

            // ç»˜åˆ¶çŸ©å½¢æ¡†
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

            // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯
            const text = `${id}å·æ¡†`;
            ctx.font = '12px sans-serif';
            const textWidth = ctx.measureText(text).width;

            ctx.fillStyle = color;
            ctx.fillRect(x1, y1 - 20, textWidth + 8, 20);

            // ç»˜åˆ¶æ ‡ç­¾æ–‡å­—
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText(text, x1 + 4, y1 - 6);
        };

        const testCanvasDrawing = (canvas, testType = 'basic') => {
            if (!canvas) {
                console.error('Canvaså…ƒç´ ä¸å­˜åœ¨');
                return null;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('æ— æ³•è·å–Canvasä¸Šä¸‹æ–‡');
                return null;
            }

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let testBoxes = [];
            let testDescription = '';

            switch (testType) {
                case 'basic':
                    testBoxes = generateMockBoxes();
                    testDescription = 'åŸºç¡€æ£€æµ‹æ¡†æµ‹è¯•';
                    break;
                case 'boundary':
                    testBoxes = generateBoundaryTestBoxes();
                    testDescription = 'è¾¹ç•Œæ¡ä»¶æµ‹è¯•';
                    break;
                case 'empty':
                    testDescription = 'ç©ºæ•°æ®æµ‹è¯•';
                    break;
                default:
                    testBoxes = generateMockBoxes();
                    testDescription = 'åŸºç¡€æ£€æµ‹æ¡†æµ‹è¯•';
            }

            // ç»˜åˆ¶æ‰€æœ‰æ£€æµ‹æ¡†
            testBoxes.forEach(box => drawSingleBox(ctx, box));

            // æ·»åŠ æµ‹è¯•ä¿¡æ¯æ˜¾ç¤º
            ctx.fillStyle = '#374151';
            ctx.font = '14px sans-serif';
            ctx.fillText(`æµ‹è¯•ç±»å‹: ${testDescription}`, 10, 30);
            ctx.fillText(`æ£€æµ‹æ¡†æ•°é‡: ${testBoxes.length}`, 10, 50);
            ctx.fillText(`è®¾å¤‡åƒç´ æ¯”: ${window.devicePixelRatio || 1}`, 10, 70);

            if (testBoxes.length > 0) {
                const labelCounts = testBoxes.reduce((acc, box) => {
                    acc[box.label] = (acc[box.label] || 0) + 1;
                    return acc;
                }, {});

                ctx.fillText('ç”µæ†ç±»å‹åˆ†å¸ƒ:', 10, 90);
                Object.entries(labelCounts).forEach(([label, count], index) => {
                    const color = getBoxColor(label);
                    ctx.fillStyle = color;
                    ctx.fillText(`â€¢ ${label}: ${count}ä¸ª`, 20, 110 + index * 20);
                });
            }

            return {
                success: true,
                testType,
                boxCount: testBoxes.length,
                canvasSize: { width: canvas.width, height: canvas.height }
            };
        };

        const initCanvas = () => {
            const canvas = document.getElementById('testCanvas');
            const dpr = window.devicePixelRatio || 1;

            // è®¾ç½®Canvaså°ºå¯¸ï¼ˆè€ƒè™‘devicePixelRatioï¼‰
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;

            // ç¼©æ”¾åæ ‡ç³»
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);

            console.log(`Canvasåˆå§‹åŒ–: ${canvas.width}Ã—${canvas.height}, DPR: ${dpr}`);
            return canvas;
        };

        window.runTest = (testType) => {
            const canvas = initCanvas();
            const result = testCanvasDrawing(canvas, testType);

            if (result) {
                const resultDiv = document.getElementById('testResult');
                const timestamp = new Date().toLocaleTimeString();

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
âœ… [${timestamp}] ${testType}æµ‹è¯•å®Œæˆ

ğŸ“Š æµ‹è¯•ç»“æœï¼š
â€¢ æµ‹è¯•çŠ¶æ€: æˆåŠŸ
â€¢ æµ‹è¯•ç±»å‹: ${result.testType}
â€¢ æ£€æµ‹æ¡†æ•°é‡: ${result.boxCount}
â€¢ Canvaså°ºå¯¸: ${result.canvasSize.width}Ã—${result.canvasSize.height}
â€¢ è®¾å¤‡åƒç´ æ¯”: ${window.devicePixelRatio || 1}

${result.boxCount > 0 ? `ğŸ¯ æ£€æµ‹æ¡†è¯¦æƒ…:\n${generateMockBoxes().map(box => {
    const [x1, y1, x2, y2] = box.xyxy;
    const width = x2 - x1;
    const height = y2 - y1;
    return `  ${box.id}å·æ¡† (${box.label}): ä½ç½®(${x1},${y1}) å°ºå¯¸(${width}Ã—${height})`;
}).join('\n')}` : ''}

ğŸ“‹ éªŒè¯åŠŸèƒ½:
âœ… Canvaså°ºå¯¸è‡ªé€‚åº”
âœ… devicePixelRatioå¤„ç†
âœ… ä¸‰ç§ç”µæ†ç±»å‹é¢œè‰²
âœ… drawBoxeså‡½æ•°éª¨æ¶
âœ… Mockæ•°æ®ç»˜åˆ¶æµ‹è¯•
                `;
            } else {
                document.getElementById('testResult').innerHTML = 'âŒ æµ‹è¯•å¤±è´¥';
            }
        };

        window.clearCanvas = () => {
            const canvas = document.getElementById('testCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            document.getElementById('testResult').className = 'result';
            document.getElementById('testResult').innerHTML = 'ğŸ§¹ ç”»å¸ƒå·²æ¸…ç©º';
        };

        window.testDevicePixelRatio = () => {
            const canvas = initCanvas();
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶1pxçº¿æ¡æµ‹è¯•
            ctx.strokeStyle = '#EF4444';
            ctx.lineWidth = 1;
            ctx.strokeRect(50, 50, 100, 100);

            ctx.fillStyle = '#EF4444';
            ctx.font = '14px sans-serif';
            ctx.fillText('1pxè¾¹æ¡†æµ‹è¯•', 60, 80);
            ctx.fillText(`Canvas: ${canvas.width}Ã—${canvas.height}`, 60, 100);
            ctx.fillText(`Device: ${window.devicePixelRatio || 1}x`, 60, 120);

            document.getElementById('testResult').className = 'result info';
            document.getElementById('testResult').innerHTML = `
ğŸ–¼ï¸ Device Pixel Ratio æµ‹è¯•å®Œæˆ
ğŸ“ Canvaså®é™…å°ºå¯¸: ${canvas.width}Ã—${canvas.height}
ğŸ“± è®¾å¤‡åƒç´ æ¯”: ${window.devicePixelRatio || 1}x
âœ… å¦‚æœçº¿æ¡æ¸…æ™°è¯´æ˜DPIé€‚é…æ­£ç¡®
            `;
        };

        window.testCanvasSync = () => {
            const canvas = initCanvas();
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶Canvaså°ºå¯¸ä¿¡æ¯
            ctx.fillStyle = '#374151';
            ctx.font = '14px sans-serif';
            const rect = canvas.getBoundingClientRect();

            ctx.fillText('CanvasåŒæ­¥æµ‹è¯•', 10, 30);
            ctx.fillText(`æ˜¾ç¤ºå°ºå¯¸: ${Math.round(rect.width)}Ã—${Math.round(rect.height)}px`, 10, 50);
            ctx.fillText(`å®é™…å°ºå¯¸: ${canvas.width}Ã—${canvas.height}px`, 10, 70);
            ctx.fillText(`è®¾å¤‡åƒç´ æ¯”: ${window.devicePixelRatio || 1}`, 10, 90);
            ctx.fillText(`ç¼©æ”¾æ¯”ä¾‹: ${canvas.width / rect.width}x`, 10, 110);

            // ç»˜åˆ¶è¾¹æ¡†
            ctx.strokeStyle = '#3B82F6';
            ctx.lineWidth = 2;
            ctx.strokeRect(2, 2, rect.width - 4, rect.height / (window.devicePixelRatio || 1) - 4);

            document.getElementById('testResult').className = 'result info';
            document.getElementById('testResult').innerHTML = `
ğŸ”„ Canvaså°ºå¯¸è‡ªé€‚åº”æµ‹è¯•å®Œæˆ
ğŸ“ æ˜¾ç¤ºå°ºå¯¸: ${Math.round(rect.width)}Ã—${Math.round(rect.height)}px
ğŸ¯ å®é™…å°ºå¯¸: ${canvas.width}Ã—${canvas.height}px
ğŸ“± ç¼©æ”¾æ¯”ä¾‹: ${canvas.width / rect.width}x
âœ… å°ºå¯¸è‡ªé€‚åº”é€»è¾‘å·¥ä½œæ­£å¸¸
            `;
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            const canvas = initCanvas();
            document.getElementById('testResult').innerHTML = `
ğŸš€ Canvaså·²åˆå§‹åŒ–ï¼Œç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹éªŒè¯

ğŸ“‹ æµ‹è¯•è¯´æ˜ï¼š
â€¢ åŸºç¡€æµ‹è¯•ï¼šéªŒè¯3ç§ç”µæ†ç±»å‹çš„æ ‡å‡†æ£€æµ‹æ¡†ç»˜åˆ¶
â€¢ è¾¹ç•Œæµ‹è¯•ï¼šéªŒè¯è¾¹ç¼˜ã€å°æ¡†ã€å¤§æ¡†ç­‰è¾¹ç•Œæƒ…å†µ
â€¢ ç©ºæ•°æ®æµ‹è¯•ï¼šéªŒè¯æ— æ£€æµ‹æ¡†æ—¶çš„å¤„ç†èƒ½åŠ›
â€¢ DPIé€‚é…æµ‹è¯•ï¼šéªŒè¯é«˜åˆ†è¾¨ç‡å±å¹•çš„devicePixelRatioå¤„ç†
â€¢ CanvasåŒæ­¥æµ‹è¯•ï¼šéªŒè¯Canvaså°ºå¯¸è‡ªé€‚åº”é€»è¾‘

ğŸ¯ æ‰€æœ‰æµ‹è¯•éƒ½ä½¿ç”¨Mockæ•°æ®ï¼Œæ¨¡æ‹ŸBæœªå®ŒæˆYOLOæ¨ç†çš„æƒ…å†µ
            `;

            // è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
            setTimeout(() => {
                runTest('basic');
            }, 1000);
        });
    </script>
</body>
</html>