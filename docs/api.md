以下是修复后的完整 `api.md` 文档内容，已按要求完成五项关键修正：

---
## Ⅰ. 全局规范与返回格式

### 1. 统一返回结构 (所有接口通用)

所有接口的 HTTP 状态码均为 **200 OK**，通过 JSON 字段 `success` 区分业务成功与失败。

| **字段**  | **类型**       | **描述**                                            |
| --------- | -------------- | --------------------------------------------------- |
| `success` | Boolean        | `true` 表示业务成功；`false` 表示业务失败/错误。    |
| `data`    | Object / Array | 成功时返回的业务数据 (失败时此字段通常为空)。       |
| `error`   | String         | 失败时返回的错误信息或错误码 (成功时此字段不存在)。 |

#### 成功返回示例：

```json
{
  "success": true,
  "data": { 
    // 成功时返回的业务数据，根据接口不同而变化
  }
}
```

#### 错误返回示例 (错误码规范)：

```json
{
  "success": false,
  "error": "TASK_NOT_FOUND" 
}
```

> **常见错误码（A需实现）：** `UPLOAD_INVALID_FILE` (文件格式/大小不符), `DETECT_FAILED` (推理失败), `TASK_NOT_FOUND` (任务ID不存在), `UPLOAD_SAVE_FAILED` (保存失败), `DETECTIONS_NOT_FOUND` (检测结果不存在), `HISTORY_LOAD_FAILED` (历史记录加载失败), `INTERNAL_ERROR` (服务器内部错误)。

### 2. 核心数据类型规范

| **数据名称** | **规范**                                                 | **示例**                 |
| ------------ | -------------------------------------------------------- | ------------------------ |
| `task_id`    | 字符串，前缀为 `local_`，后接 6-8 位随机小写字母或数字。 | `"local_f3a9c2"`         |
| `created_at` | 字符串，ISO 8601 格式，用于历史记录展示。                | `"2025-11-17T10:30:00Z"` |

---

## Ⅱ. 核心 API 接口定义

### 1. POST /upload - 视频上传与元信息获取

| **规范点**   | **详情**                                                     |
| ------------ | ------------------------------------------------------------ |
| **功能**     | 上传 MP4 文件，后端保存文件并提取元信息，写入 `tasks` 表。   |
| **请求方式** | `POST`                                                       |
| **请求体**   | `multipart/form-data`，**字段名**必须为 `file` (MP4 文件)。  |
| **文件约束** | 仅支持 `video/mp4` 格式，文件大小 ≤ 100MB。超出限制返回 `UPLOAD_INVALID_FILE`。 |

**成功返回示例：**

```json
{
  "success": true,
  "data": {
    "task_id": "local_f3a9c2",
    "fps": 30,
    "duration": 120.5,
    "frame_count": 3600,
    "width": 1920,
    "height": 1080
  }
}
```

---

### 2. POST /detect/{task_id} - 模型推理触发 (同步/幂等)

| **规范点**   | **详情**                                     |
| ------------ | -------------------------------------------- |
| **功能**     | 触发 YOLOv8 模型推理。**设计核心为幂等性**。 |
| **请求方式** | `POST`                                       |
| **路径参数** | `task_id` (字符串)                           |

**成功返回示例 A：首次推理成功 (后端A必须检查 JSON 文件是否存在)**

```json
{
  "success": true,
  "data": {
    "generated": true,   // 表示本次触发了推理，并已生成 JSON 文件
    "task_id": "local_f3a9c2"
  }
}
```

**成功返回示例 B：结果已存在 (幂等性生效)**

```json
{
  "success": true,
  "data": {
    "generated": false,           // 表示本次未推理
    "already_exists": true,       // 表示结果文件已存在，可直接调用 /detections
    "task_id": "local_f3a9c2"
  }
}
```

---

### 3. GET /detections/{task_id} - 获取检测结果 JSON

| **规范点**   | **详情**                                                   |
| ------------ | ---------------------------------------------------------- |
| **功能**     | 读取并返回 `./data/detections/{task_id}.json` 文件的内容。 |
| **请求方式** | `GET`                                                      |
| **路径参数** | `task_id` (字符串)                                         |

**标签枚举说明**：
模型输出的 `label` 字段仅允许以下三种枚举值：
- `iron_pole`：钢制电杆
- `concrete_pole`：混凝土电杆
- `iron_gantry_pole`：钢制门型电杆

**成功返回示例 (数据结构核心)：**

```json
{
  "success": true,
  "data": [   // 顶层结构必须是数组
    {
      "frame_index": 0,    // 帧索引 (int)
      "time": 0.0,         // 视频时间点 (float)
      "boxes": [           // 当前帧的所有检测框
        {
          "id": 1,         // ❗️ 关键：帧内索引，从 1 开始递增 (非跨帧跟踪 ID)
          "xyxy": [120, 300, 350, 620], // 像素坐标（绝对坐标）
          "label": "iron_pole"         // 标签 (来自模型输出)
        },
        {
          "id": 2,
          "xyxy": [500, 400, 700, 800],
          "label": "concrete_pole"
        }
      ]
    },
    // ... 更多帧数据
  ]
}
```

---

### 4. GET /videos/{task_id} - 视频流服务

| **规范点**   | **详情**                                           |
| ------------ | -------------------------------------------------- |
| **功能**     | 提供视频文件流服务，供前端 `video.js` 播放器调用。 |
| **请求方式** | `GET`                                              |
| **路径参数** | `task_id` (字符串)                                 |

**实现要求**：后端 A 需使用 FastAPI 的 `FileResponse` 或 `StreamingResponse` 来返回视频文件 `videos/{task_id}/video.mp4`，以支持 `video.js` 的 **Seek**（拖动进度条）功能。

**错误返回示例：**

```json
{
  "success": false,
  "error": "TASK_NOT_FOUND"
}
```

---

### 5. GET /history - 历史任务列表

| **规范点**   | **详情**                                                     |
| ------------ | ------------------------------------------------------------ |
| **功能**     | 返回数据库中所有已上传的视频任务列表。供 `HistoryPage` (C 负责) 使用。 |
| **请求方式** | `GET`                                                        |

**成功返回示例：**

```json
{
  "success": true,
  "data": [
    {
      "task_id": "local_f3a9c2",
      "created_at": "2025-11-16T10:20:00Z"
    },
    {
      "task_id": "local_93bd21",
      "created_at": "2025-11-17T09:05:00Z"
    }
    // ... 更多任务
  ]
}
```

> **字段说明**：`line_name` 为 P1 预留字段，P0 阶段不应在 `/history` 接口中返回。

---
