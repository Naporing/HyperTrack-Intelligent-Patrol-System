# 智能高铁巡检系统 - 四人协作开发计划（优化版）

**基于7天MVP开发计划，整合需求文档与技术规范，针对项目策划/仓库管理员C的职责优化后的协作方案**

---

## 一、团队角色与职责

| 角色                               | 职责                                   | 核心模块                                                     | 技术栈                            |
| :--------------------------------- | :------------------------------------- | :----------------------------------------------------------- | :-------------------------------- |
| **开发者A**<br>后端架构师          | **纯后端服务**（接口、数据库、视频流） | `/upload`, `/detect`, `/detections`, `/videos`, `/history`, `tasks`表 | FastAPI, SQLite, Python           |
| **开发者B**<br>AI模型工程师        | YOLOv8集成、检测逻辑、性能优化         | 模型推理、检测JSON生成、性能测试                             | ultralytics, ONNX, OpenCV         |
| **开发者C**<br>项目策划/仓库管理员 | **HistoryPage实现 + 项目管理**         | 历史任务列表、项目文档归总、Git管理、风险管理                | React, Git, 项目管理工具          |
| **开发者D**<br>前端主程            | **所有前端实现**（除HistoryPage）      | UploadPage, InspectPage, VideoPlayer, CanvasOverlay, AnnotationPanel | React, video.js, Canvas, Tailwind |

---

## 二、协作原则与规范

### 1. **接口契约先行**

- **每天碰头**（15分钟）由**C组织**，同步接口变更，使用Postman共享接口集合
- 所有接口统一返回格式，错误码必须来自P0最小集合
- 接口文档由**A维护**，C负责每日检查文档同步情况，实时更新到Git仓库的`/docs/api.md`

### 2. **代码协作流程**

- **Git分支策略**：`main`分支（保护），个人功能分支 `feature/{姓名}/{功能}`
- **代码检查**：每天结束前提交PR，**C负责审核合并**，至少一人review通过才能合并
- **Claude Code使用**：D负责整理高频Prompt模板，团队共享（见第1天任务）

### 3. **联调机制**
- **每日联调时间**：19:00-20:00（晚饭后）集中解决跨端问题，**C负责协调**
- **Mock数据**：D负责在B未完成时提供模拟检测数据，格式必须严格符合规范
- **同步标记**：接口联调完成后在代码注释中添加 `# SYNCED` 标记，**C每日抽查**

---

## 三、7天并行开发计划

### **第1天：环境准备与项目初始化（全局同步日）**

**目标**：四人环境一致，前后端项目可运行，接口契约确定

| 时间            | 开发者A                                                      | 开发者B                                                      | 开发者C                                                      | 开发者D                                                      |
| :-------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **19:00-20:30** | 1. 初始化FastAPI项目，创建`main.py`<br>2. 配置Python虚拟环境、`requirements.txt`<br>3. 编写`tasks`表SQL脚本，实现数据库初始化函数 | 1. 安装`ultralytics==8.x`和`onnxruntime`<br>2. 下载并测试`best.onnx`模型加载<br>3. 编写单帧推理测试脚本，验证输出格式 | 1. **创建Git仓库，设置分支保护规则**<br>2. **创建`docs/api.md`模板，定义接口规范**<br>3. 初始化Vite+React项目（轻量参与，了解结构） | 1. 配置TailwindCSS，创建基础样式<br>2. 创建基础页面结构（Upload, Inspect, History）<br>3. 设计Canvas绘制测试页，准备坐标转换工具函数 |
| **20:30-21:00** | **碰头会**：C演示Git流程与分支策略，A讲解接口规范与数据库设计，B展示模型调用示例，D分发Claude Code使用指南与Prompt模板 |                                                              |                                                              |                                                              |

**交付物**：
- ✅ Git仓库（main分支保护规则）+ 初始commit
- ✅ 前后端可运行空项目（`npm run dev`和`uvicorn main:app --reload`成功）
- ✅ `docs/api.md`（包含所有5个接口的完整签名与返回格式）
- ✅ `docs/claude-prompts.md`（共享Prompt模板，包含FastAPI、Canvas、CORS等）

---

### **第2天：上传功能与视频存储（前后端并行）**

**目标**：视频可上传，后端保存并生成task_id，前端可跳转

| 开发者A                                                      | 开发者B                                                      | 开发者C                                                      | 开发者D                                                      |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **核心任务**：<br>1. 实现`/upload`接口（`POST`, `multipart/form-data`）<br>2. 实现`task_id`生成逻辑（`local_`+6位随机小写字母数字）<br>3. 创建`./data/videos/{task_id}/`目录结构<br>4. 使用OpenCV提取视频元信息（`fps`, `frame_count`, `duration`, `width`, `height`）<br>5. 将元信息写入SQLite `tasks`表，返回统一JSON格式 | **核心任务**：<br>1. 封装`model = YOLO("models/best.onnx")`单例模式<br>2. 编写视频帧提取工具函数`extract_frames(video_path)`<br>3. **协助A**：提供`get_video_metadata(video_path)`函数，返回元信息字典 | **核心任务**：<br>1. **组织碰头会，同步各成员进度**<br>2. **审核A的接口文档更新**<br>3. **创建`docs/risk-board.md`风险看板**<br>4. 轻量参与：Review D的UploadPage代码 | **核心任务**：<br>1. **实现UploadPage完整页面**：文件选择按钮、拖拽区域、上传进度条<br>2. 封装API调用层`api.uploadVideo(file)`，处理`success/error`响应<br>3. 上传成功后跳转`navigate("/inspect/{task_id}")`<br>4. 错误处理：根据`error`字段显示具体提示（如"文件过大"） |
| **关键接口**：<br>`POST /upload`（返回`task_id`, `fps`, `frame_count`, `duration`, `width`, `height`） | **关键输出**：<br>视频处理工具函数 + 单帧推理验证            | **关键产出**：<br>风险看板 + 接口文档审核记录                | **关键交互**：<br>上传进度条、错误提示、成功跳转             |

**联调时间**：
- **19:00** A与D联调`/upload`接口，确保文件能送达并返回正确JSON
- **19:30** B向A确认视频存储路径规范，确保后续检测可找到文件
- **20:00** C组织代码检查，合并`feature/upload-pages`分支到main

---

### **第3天：YOLO检测与结果存储（核心AI日）**

**目标**：检测接口可运行，生成符合规范的JSON文件

| 开发者A                                                      | 开发者B                                                      | 开发者C                                                      | 开发者D                                                      |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **核心任务**：<br>1. 实现`/detect/{task_id}`接口骨架（`POST`）<br>2. 实现幂等性检查：若`./data/detections/{task_id}.json`存在，直接返回`already_exists: true`<br>3. 调用B的`run_detection(video_path, task_id)`函数<br>4. 将返回的检测结果列表写入JSON文件<br>5. 接口返回统一格式：`{success: true, data: {generated: true/false, task_id}}` | **核心任务**：<br>1. 实现`run_detection(video_path, task_id)`函数<br>2. 视频逐帧推理逻辑（30fps全量检测，不做采样）<br>3. **按规范生成JSON数组**：每个元素含`frame_index`, `time`, `boxes`（`id`, `xyxy`, `label`）<br>4. `box_id`在帧内从1递增，不保证全局唯一<br>5. 将结果列表返回给A的接口 | **核心任务**：<br>1. **碰头会同步**：确认B的检测进度，判断是否需要D提供mock数据<br>2. **实现InspectPage框架**：路由`/inspect/:task_id`，状态管理（`task_id`, `detections`, `loading`）<br>3. 在页面加载时自动调用`/detect/{task_id}`，显示检测状态<br>4. **更新风险看板**：标记"检测性能风险"状态 | **核心任务**：<br>1. **实现Canvas尺寸自适应逻辑**：<br>   - 监听video的`loadedmetadata`事件，设置canvas.width/height<br>   - 监听`resize`和`fullscreenchange`事件，同步canvas尺寸<br>   - 考虑`devicePixelRatio`避免模糊<br>2. 编写`drawBoxes(ctx, boxes)`函数骨架，准备接收box数据<br>3. **测试**：使用mock数据（若B未完成）验证Canvas能正确绘制矩形框 |
| **关键接口**：<br>`POST /detect/{task_id}`（幂等性保证）     | **关键输出**：<br>符合规范的`detections.json`文件 + 推理耗时统计 | **关键产出**：<br>InspectPage框架 + 风险看板更新             | **关键组件**：<br>`<CanvasOverlay/>`尺寸同步逻辑             |

**联调时间**：
- **19:00** A与B深度联调：`/detect`接口调用推理引擎，确认JSON格式符合规范
- **19:30** C与D联调：将mock的检测数据绘制到Canvas上，验证坐标系正确
- **20:00** 四人审查第一个生成的`detections.json`文件格式，C组织评审

---

### **第4天：检测结果显示与Canvas绘制（前端攻坚日）**

**目标**：视频播放时Canvas框能准确同步

| 开发者A                                                      | 开发者B                                                      | 开发者C                                                      | 开发者D                                                      |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **核心任务**：<br>1. 实现`/detections/{task_id}`接口（`GET`）<br>2. 读取`./data/detections/{task_id}.json`文件，返回完整数组<br>3. 添加错误处理：文件不存在返回`{success: false, error: "DETECTIONS_NOT_FOUND"}`<br>4. **性能优化**：对100MB+视频的JSON文件，考虑使用流式响应或分页加载 | **核心任务**：<br>1. **性能优化**：检测JSON文件加载性能，大文件读取优化<br>2. **协助D**：提供bbox坐标转换算法咨询（视频分辨率→Canvas坐标）<br>3. 编写YOLO阈值配置文档（P0用默认，但预留配置项） | **核心任务**：<br>1. **碰头会同步**：确认Canvas绘制进度，识别技术阻塞<br>2. **质量检查**：审核B生成的首个`detections.json`，确保100%符合规范<br>3. **组织UI评审**：D展示Canvas绘制效果，团队确认颜色、线宽、同步精度<br>4. **归档**：将UI评审结论写入`docs/ui-decisions.md` | **核心任务**：<br>1. **VideoPlayer集成video.js**：播放`/videos/{task_id}`，控制栏定制<br>2. **实现time→frame_index映射算法**：<br>   - 在`timeupdate`事件中计算`frame_index = Math.floor(currentTime * fps)`<br>   - 从缓存的detections数组中查找对应帧的boxes<br>3. **Canvas核心绘制逻辑**：<br>   - 每帧清空canvas<br>   - 遍历boxes，按`xyxy`坐标绘制矩形<br>   - 三种电杆类型使用不同颜色（如iron_pole=红, concrete_pole=蓝, iron_gantry_pole=绿）<br>4. 全屏切换时触发Canvas重绘，确保坐标不偏移 |
| **关键接口**：<br>`GET /detections/{task_id}`（大文件性能）  | **关键支持**：<br>坐标系转换算法 + 性能优化建议              | **关键产出**：<br>UI评审记录 + 质量检查报告                  | **核心算法**：<br>`timeupdate` → `frame_index` → `drawBoxes` |

**联调时间**：
- **19:00-20:30** 四人一起测试：从上传→检测→播放→绘框端到端测试
- **关键验证**：拖动进度条，框的同步误差<100ms，C负责计时验证

---

### **第5天：视频流服务与历史页面（后端服务化日）**

**目标**：历史任务可查看，视频可播放，前后端解耦

| 开发者A                                                      | 开发者B                                                      | 开发者C                                                      | 开发者D                                                      |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **核心任务**：<br>1. 实现`/videos/{task_id}`接口（`GET`），使用FastAPI的`FileResponse`<br>2. **验证HTTP Range请求支持**：确保video.js可正常seek<br>3. 实现`/history`接口（查询SQLite `tasks`表，返回`task_id`, `created_at`）<br>4. 添加视频文件存在性检查，不存在返回`TASK_NOT_FOUND` | **核心任务**：<br>1. **性能测试**：检测大视频（>50MB）推理时的内存占用，记录峰值<br>2. **文档**：编写`docs/model.md`（模型说明、默认阈值、推理速度）<br>3. 测试不同视频分辨率（720p/1080p）的兼容性 | **核心任务**：<br>1. **碰头会同步**：确认A的接口完成情况，协调D的前端对接<br>2. **实现HistoryPage完整页面**：<br>   - 调用`/history`接口，获取任务列表<br>   - 使用`<table>`或卡片布局展示`task_id`和`created_at`<br>   - 点击"进入查看"按钮，调用`navigate("/inspect/{task_id}")`<br>3. **测试联调**：与A确认`/history`返回数据格式，与D确认跳转逻辑<br>4. **更新风险看板**：标记"视频流性能"状态 | **核心任务**：<br>1. **InspectPage通用化改造**：支持URL参数`task_id`，可从历史页跳转进入<br>2. **video.js配置优化**：<br>   - 倍速播放（1.0x/2.0x按钮）<br>   - 自定义控制栏样式（隐藏不需要的按钮）<br>3. **Canvas全屏适配**：<br>   - 全屏时重新计算canvas尺寸<br>   - 坐标转换确保框不偏移<br>4. 编写播放性能测试用例（记录卡顿帧率） |
| **关键接口**：<br>`GET /videos/{task_id}`（支持Range） + `GET /history` | **关键输出**：<br>性能测试报告 + 模型文档                    | **关键组件**：<br>`<HistoryPage/>`完整实现                   | **关键优化**：<br>全屏Canvas坐标转换 + video.js定制          |

**联调时间**：
- **19:00** A与C联调`/history`接口，确保返回数据格式正确
- **19:30** 四人完整测试：上传视频→刷新历史页→跳转InspectPage→播放+Canvas正常

---

### **第6天：标注入口UI与交互（前端完善日）**

**目标**：右侧标注区可点击，有反馈，体现系统完整性

| 开发者A                                                      | 开发者B                                                      | 开发者C                                                      | 开发者D                                                      |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **核心任务**：<br>1. **性能调优**：检查`/detect`接口在大视频下的内存泄漏<br>2. 协助D理解`box_id`三元组定位机制<br>3. 编写接口性能优化文档 | **核心任务**：<br>1. 完成模型兼容性测试，记录不同分辨率下的推理速度<br>2. 协助D完成Canvas最终调试 | **核心任务**：<br>1. **碰头会同步**：确认D的标注UI进度，协调最终联调<br>2. **组织功能评审**：D展示AnnotationPanel，团队确认交互反馈效果<br>3. **项目文档归总**：<br>   - 归档`docs/ui-decisions.md`<br>   - 更新`docs/user_manual.md`使用指南<br>4. **更新风险看板**：所有风险标记为"已关闭"或"已确认" | **核心任务**：<br>1. **AnnotationPanel右侧布局实现**：<br>   - 显示当前帧检测目标列表（从`boxes`生成）<br>   - 每项显示格式：`{id}号框 ({label}) [标注(演示)]`<br>2. **"标注(演示)"按钮交互**：<br>   - 点击后显示`alert("标注功能将在后续版本开放")`<br>   - 可选：临时高亮当前行（2秒后恢复）<br>3. **"已标注记录(演示版)"占位**：显示文案"未来版本将展示人工标注截图与好/坏状态"<br>4. **整体UI美化**：使用Tailwind调整颜色、间距、字体，确保视觉效果专业 |
| **关键支持**：<br>性能优化 + 定位机制解释                    | **关键输出**：<br>兼容性测试报告                             | **关键产出**：<br>功能评审记录 + 文档归总 + 风险关闭         | **关键组件**：<br>`<AnnotationPanel/>`完整交互               |

**联调时间**：
- **19:30** **C组织功能评审**：D展示AnnotationPanel，团队确认交互反馈效果
- **20:00** A确认所有接口错误码符合P0最小集合，C检查代码注释中的`# SYNCED`标记

---

### **第7天：测试、调试与文档（全员收尾日）**

**目标**：全功能通过测试，文档齐全，准备演示

| 开发者A                                                      | 开发者B                                                      | 开发者C                                                      | 开发者D                                                      |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **核心任务**：<br>1. **后端全接口压力测试**：模拟3个并发上传请求，检查稳定性<br>2. 编写`docs/deployment.md`（部署步骤、环境变量、依赖安装）<br>3. 整理`requirements.txt`并锁定版本（`pip freeze > requirements.txt`）<br>4. 编写接口使用示例`curl`命令集合<br>5. 录制后端接口演示视频（Postman调用） | **核心任务**：<br>1. **模型推理耗时统计**：计算平均fps，记录不同分辨率下的速度<br>2. 编写`docs/model.md`（模型说明、默认阈值、推理配置）<br>3. 测试不同视频分辨率（720p/1080p）的兼容性<br>4. 录制模型推理演示视频（命令行输出） | **核心任务**：<br>1. **组织最终演示彩排**：四人按评审流程预演，C计时并记录问题<br>2. **项目文档归总**：<br>   - 将所有文档合并到`docs/`目录<br>   - 创建`docs/index.md`作为文档首页<br>3. **Git管理**：<br>   - 打tag `mvp-p0`标记版本<br>   - 撰写Release Notes<br>4. **编写项目总结报告**：统计代码量、联调次数、风险应对情况 | **核心任务**：<br>1. **全系统端到端测试**：<br>   - 测试用例1：上传→检测→播放→绘框（检查同步精度）<br>   - 测试用例2：历史页跳转播放（检查路由和状态）<br>   - 测试用例3：检测JSON不存在时的错误提示<br>2. **Canvas极限测试**：30fps视频下是否卡顿，记录帧率<br>3. 编写`docs/user_manual.md`（用户操作指南）<br>4. **录制30秒演示视频**：展示完整操作流程（上传、检测、播放、标注点击） |
| **交付**：<br>部署文档 + 接口演示视频                        | **交付**：<br>模型文档 + 性能测试报告                        | **交付**：<br>项目总结报告 + Release Notes + 所有文档归总    | **交付**：<br>测试报告 + 演示视频 + 用户手册                 |

**团队活动**：
- **19:00-20:30** **C主持完整演示彩排**：每人展示自己负责模块，严格控制时间（每人5分钟）
- **20:30-21:00** **文档归档**：C将所有文档合并到`docs/`目录，Git打tag `mvp-p0`，上传演示视频到Git LFS

---

## 四、关键协作产出物

### 1. **每日碰头记录模板**（由**C组织**）
```
【日期】2025-11-XX
【组织者】C
【昨日完成】
  - A: XXX
  - B: XXX
  - C: XXX
  - D: XXX
【今日计划】
  - A: XXX
  - B: XXX
  - C: XXX
  - D: XXX
【阻塞问题】
  - XXX（需要谁协助）
```

### 2. **接口状态看板**（由**A维护**，**C每日检查**）
```
【更新日期】2025-11-XX 19:00
/upload: ✅ 已实现（commit: abc123）
/detect/{task_id}: 🔲 联调中（阻塞：等待B推理完成）
/detections/{task_id}: ❌ 有bug（问题：大文件JSON加载慢）
/videos/{task_id}: ⬜ 未开始
/history: ⬜ 未开始
```

### 3. **Claude Code共享Prompt库**（由**D维护**）
- `prompts/generate_api.md`：生成FastAPI接口模板
- `prompts/generate_canvas.md`：生成Canvas绘制代码
- `prompts/fix_cors.md`：解决跨域问题
- `prompts/generate_videojs.md`：生成video.js配置代码

### 4. **风险看板**（由**C维护**）
- `docs/risk-board.md`：
  - 风险1: YOLO推理速度慢（概率中，负责人B，应对方案：降低分辨率）
  - 风险2: Canvas全屏错位（概率高，负责人D，应对方案：降级隐藏）
  - 风险3: 接口格式不一致（概率低，负责人A，应对方案：每日快照）

---

## 五、风险与应对

| 风险                     | 概率 | 应对方案                                          | 负责人 |
| :----------------------- | :--- | :------------------------------------------------ | :----- |
| YOLO推理速度慢           | 中   | 降低测试视频分辨率至720p；B提前准备分块推理方案   | B      |
| Canvas全屏错位           | 高   | D第4天重点测试，C准备降级方案（全屏时隐藏Canvas） | D      |
| 接口格式不一致           | 低   | A每天17:00发接口快照到群，C使用前验证并反馈       | A      |
| Claude Code生成代码有bug | 中   | 必须由人工review，复杂逻辑（如同步算法）手写      | 全员   |
| 第7天集成失败            | 低   | 第6天必须完成个人模块，预留21:00-22:00应急缓冲    | C      |

---

## 六、成功标准

**P0 MVP完成标准**：
1. ✅ 可上传≤100MB MP4视频，返回正确`task_id`和元信息
2. ✅ 检测生成`detections.json`格式100%符合规范（三元组定位准确）
3. ✅ video.js播放视频，Canvas框同步显示误差<100ms
4. ✅ HistoryPage可跳转，InspectPage复用逻辑正确
5. ✅ 右侧标注按钮有交互反馈（alert提示或临时高亮）
6. ✅ 所有接口统一错误格式，`success/error`字段明确
7. ✅ 文档齐全（部署、接口、模型、用户手册、UI决策）
8. ✅ **Git提交记录**：四人均衡（每人15±3次commit），均有检查记录
9. ✅ **项目管理**：C完成7次碰头记录、风险看板每日更新、项目总结报告

**评审日（第7天21:00）**：四人向虚拟评委演示完整流程
- **A**讲解接口设计与幂等性保证（5分钟）
- **B**讲解YOLOv8集成与JSON生成（5分钟）
- **C**讲解HistoryPage实现与项目管理（5分钟）
- **D**讲解Canvas同步算法与video.js集成（5分钟）
- **C**总结项目亮点（2分钟）

---

## 七、C的每日管理任务清单

| 时间       | 任务                                              |
| :--------- | :------------------------------------------------ |
| **碰头前** | Review昨日Git提交，检查代码注释中的`# SYNCED`标记 |
| **碰头会** | 15分钟，使用记录模板同步进度，识别阻塞            |
| **上午**   | 审核A的接口文档更新，确保`docs/api.md`与代码同步  |
| **下午**   | 更新风险看板，跟踪风险状态，协调资源              |
| **联调前** | 准备联调检查清单，确保环境就绪                    |
| **联调后** | 组织代码检查，审核PR，合并分支，打tag记录版本     |
| **日终**   | 归档当日文档，更新项目进度记录                    |

---

**备注**：此计划假设每天有效开发时间2.5小时，同步和联调0.5小时。若某任务提前完成，应立即协助阻塞中的队友。C的管理工作约占用1小时/天，开发工作约1.5小时/天，确保技术体感与管理职责平衡。