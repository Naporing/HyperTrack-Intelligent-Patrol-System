## **整体开发计划（7 天）**

### **接口规范**：

- **返回格式**：所有接口必须统一使用以下格式：

```json
{
  "success": true,
  "data": { ... }  // 成功时返回的数据
}
```

如果发生错误，则返回以下格式：

```json
{
  "success": false,
  "error": "错误信息"
}
```

---

### **目标：**

- **核心功能：** 完成视频上传、视频检测、视频播放、检测框展示、历史任务查看等功能；
- **使用 Claude Code 辅助开发：** 节省新手开发时间，提高效率，自动化生成代码模板、解决常见的开发问题。

### **总任务拆解：**

每个开发任务都设置了合理的时间预算，考虑到新手团队和每天2-3小时的开发时间，确保任务量适当、不会过多压缩时间。

------

### **第 1 天：环境准备与项目初始化（2-3小时）**

**目标：**

- 配置前后端开发环境，初始化项目结构；
- 安装必要的依赖库。

**任务：**

1. 配置开发环境：
   - **后端环境（FastAPI）**：安装 Python，设置虚拟环境，安装 FastAPI 及其依赖。
   - **前端环境（React）**：安装 Node.js，设置 Vite + React 项目，安装 TailwindCSS。
   - **其他工具**：设置 Git 仓库，协同开发。
   
2. 创建基本的项目结构，文件夹和初步的基础代码结构。

3. **数据库初始化：**

   - 在数据库中创建 `tasks` 表，用于存储视频任务的基本信息（如 `task_id`、`fps`、`duration` 等）。示例 SQL：

   ```
   CREATE TABLE IF NOT EXISTS tasks (
     task_id TEXT PRIMARY KEY,         -- 例如 local_f3a9c2
     video_path TEXT NOT NULL,         -- ./data/videos/{task_id}/video.mp4
     fps REAL,
     frame_count INTEGER,
     duration REAL,                   -- 秒
     width INTEGER,
     height INTEGER,
     line_name TEXT,                  -- 预留给 P1（线路名称），P0 可为 NULL
     created_at TEXT NOT NULL         -- ISO8601 字符串，例如 2025-11-16T10:00:00
   );
   ```

------

### **第 2 天：上传视频接口与前端上传页面（2-3小时）**

**目标：**

- 实现视频上传接口；
- 前端页面设计并实现视频上传功能。

**任务：**

1. **后端：**
   - 创建 `/upload` 接口，接收前端上传的视频文件；
   - 使用 `FastAPI` 来接收视频文件并保存到服务器。
   - 返回统一格式的响应：
   
   ```json
   {
     "success": true,
     "data": {
       "task_id": "unique_task_id",
       "fps": 30,
       "duration": 120.5,
       "frame_count": 3600,  // 添加帧数
       "width": 1920,        // 视频宽度
       "height": 1080        // 视频高度
     }
   }
   ```
2. **前端：**
   - 创建上传页面，设计文件选择和上传按钮；
   - 使用 `axios` 或 `fetch` 调用 `/upload` 接口，上传文件并返回 `task_id`。
   - 根据接口返回的 `success` 字段处理不同的结果。
3. **Claude Code 辅助：**
   
   - 使用 Claude Code 生成 FastAPI 后端上传接口代码；
   - 使用 Claude Code 生成 React 前端上传页面的基本模板。

------

### **第 3 天：YOLO 模型推理与检测结果存储（2-3小时）**

**目标：**

- 集成 **YOLOv8**（ultralytics）模型进行视频推理；
- 存储检测结果（JSON 格式）。

**任务：**

1. **后端：**

   - **集成 YOLOv8 模型：**
     - 使用 **ultralytics/YOLOv8** 的 Python 包，通过 `from ultralytics import YOLO` 加载预训练 `best.onnx` 模型。
     - 对每个视频帧进行推理，识别电杆类型（`iron_pole`, `concrete_pole`, `iron_gantry_pole`）。
     - 在 `/detect/{task_id}` 接口中实现 YOLO 推理：
     - **幂等性**：如果 `./data/detections/{task_id}.json` 文件已存在，则直接返回 `{ "success": true, "data": { "generated": false, "already_exists": true } }`，避免重复推理。如果文件不存在，才执行推理并生成新的 JSON 文件。
     
   - **接口返回格式：**

   ```json
   {
     "success": true,
     "data": {
       "generated": true,  // 若文件不存在并重新生成
       "task_id": "unique_task_id"
     }
   }
   ```

   - **推理配置：**
     - 在 P0 阶段使用 YOLOv8 的默认参数进行推理（如 **置信度阈值**和 **NMS** 阈值）。
   - **检测帧采样策略（简化）**：
     - **统一采样策略：** 因为视频帧率为 30fps，所有帧都会进行检测。无需每隔帧进行采样，简化为每一帧都进行推理。
     - 这一简化的策略减少了视频处理的复杂度，且适用于大多数视频。

2. **前端：**

   - 无需直接修改前端界面，但需要确保前端能够正确接收从后端返回的检测结果（如视频帧的边界框 `boxes` 和标签 `labels`）。
   - 调试上传接口与YOLO推理结果的结合，确保推理结果可以正确存储并传递给前端展示。

3. **Claude Code 辅助：**

   - 使用 **Claude Code** 自动生成 YOLOv8 推理代码，简化集成过程。
   - 使用 **Claude Code** 生成存储推理结果（JSON格式）的代码。

------

### **第 4 天：检测结果获取与显示（2-3小时）**

**目标：**

- 实现 `/detections/{task_id}` 接口返回检测结果；
- 在前端通过 Canvas 绘制检测框。

**任务：**

1. **后端：**
   
   - 创建 `/detections/{task_id}` 接口，返回统一格式的检测结果：
   
   ```json
   {
     "success": true,
     "data": [
       {
         "frame_index": 0,
         "time": 0.0,
         "boxes": [
           { "id": 1, "xyxy": [100, 200, 300, 600], "label": "iron_pole" }
         ]
       },
       {
         "frame_index": 1,
         "time": 0.0333,
         "boxes": []
       }
     ]
   }
   ```
2. **前端：**

   - **Canvas 绘制：** 在绘制框时，处理 `devicePixelRatio` 和全屏事件，确保在不同设备和分辨率下，Canvas 和视频显示一致，避免画布模糊或错位。
     - 在 `loadedmetadata`、`resize` 和 `fullscreenchange` 等事件中重新计算并设置 Canvas 尺寸，使其与视频尺寸匹配。

   ```javascript
   const canvas = document.querySelector('canvas');
   const video = document.querySelector('video');
   
   // 监听视频尺寸变化事件
   video.addEventListener('loadedmetadata', function () {
     canvas.width = video.videoWidth * window.devicePixelRatio;
     canvas.height = video.videoHeight * window.devicePixelRatio;
   });
   
   // 监听全屏事件
   video.addEventListener('fullscreenchange', function () {
     if (document.fullscreenElement) {
       // 处理全屏模式
       canvas.width = video.videoWidth * window.devicePixelRatio;
       canvas.height = video.videoHeight * window.devicePixelRatio;
     } else {
       // 退出全屏模式
       canvas.width = video.videoWidth;
       canvas.height = video.videoHeight;
     }
   });
   ```
3. **Claude Code 辅助：**
   
   - 使用 Claude Code 生成 Canvas 绘制框的代码；
   - 使用 Claude Code 生成后端接口代码。

------

### **第 5 天：视频播放与历史任务页（2-3小时）**

**目标：**

- 集成 `video.js` 播放视频；
- 实现历史任务查看页面，点击任务跳转查看详细信息。

**任务：**

1. **后端：**

   - 创建 `/videos/{task_id}` 接口，使用 `FileResponse` 返回视频文件流，以供前端播放：
   - 该接口用于从服务器获取存储的视频文件。

   ```python
   from fastapi.responses import FileResponse
   from pathlib import Path
   
   @app.get("/videos/{task_id}")
   async def get_video(task_id: str):
       video_path = Path(f"./data/videos/{task_id}/video.mp4")
       if video_path.exists():
           return FileResponse(video_path)
       else:
           return {"success": false, "error": "TASK_NOT_FOUND"}
   ```

   ```json
   {
     "success": true,
     "data": {
       "video_url": "/videos/{task_id}/video.mp4"
     }
   }
   ```

2. **前端：**

   - 使用 `video.js` 播放器播放视频；
   - 在 **历史任务页面** 中列出所有历史任务，显示任务的 `task_id` 和上传时间，点击任务跳转到 **InspectPage** 播放对应视频（通过 `task_id` 进行定位），不在历史页播放视频。
   - **InspectPage**：视频播放器展示视频，点击视频任务后，进入播放界面，但不涉及标注操作。

3. **Claude Code 辅助：**

   - 使用 **Claude Code** 生成 `video.js` 播放器集成代码，确保视频可以流畅播放。
   - 使用 **Claude Code** 生成历史任务页面的基本代码结构。

------

### **第 6 天：人工标注入口与UI交互（2-3小时）**

**目标：**

- 实现标注入口的 UI 和交互（按钮，提示）；
- 为视频播放器右侧设计添加标注区，内含检测目标和标注按钮。

**任务：**

1. **前端：**
   - 在视频播放器 **右侧的标注区** 中添加“标注（演示）”按钮，而不是直接在视频播放器上添加按钮；
   - 点击该按钮时，触发提示信息，显示类似“标注功能将在后续版本（P1）中正式开放”；
   - 在页面底部或旁边显示已标注的框（演示版，不做保存）。
2. **Claude Code 辅助：**
   - 使用 **Claude Code** 生成标注区的 UI 布局代码，并快速生成按钮点击事件和提示功能的代码。

---

### **第 7 天：测试、调试与文档整理（2-3小时）**

**目标：**

- 完成全功能测试，修复已发现的问题；
- 整理开发文档，确保接口描述和项目文档完整。

**任务：**

1. **前后端测试：**
   - 测试视频上传、视频推理、历史任务查看等功能；
   - 调试前后端接口，确保视频播放与检测框显示同步。
2. **文档整理：**
   - 完成开发文档，包含接口描述、数据流、部署步骤等；
   - 记录测试用例和测试结果，确保各项功能都已通过验证。
3. **Claude Code 辅助：**
   - 使用 Claude Code 自动生成测试用例模板，简化测试过程；
   - 使用 Claude Code 生成接口文档模板，方便填写。

------

## **总结：**

- **每天工作时长**：2-3 小时，任务量适中，避免过于压缩开发时间。
- **Claude Code 辅助**：大幅提高开发效率，尤其是代码生成和常见问题解决。
- **重点功能**：视频上传、YOLO 模型推理、检测结果显示、历史任务查看、标注功能（演示）等。

**整体开发进度合理可行**，即使是新手也能在限定时间内完成 MVP 的开发。如果有其他具体问题或需要调整的地方，可以随时告诉我！