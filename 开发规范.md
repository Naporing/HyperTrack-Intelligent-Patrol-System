作为项目管理者C，我将基于五份文档提炼出**开发铁律**与**协作规范**，请各位开发者严格遵守。所有内容以**MVP需求文档 -终稿.md**为最高准则，其他文档为执行细则。

---

## **一、开发依据的优先级（必须按此顺序查阅）**

1. **最高准则**：`mvp需求文档 -终稿.md`  
   - 任何功能争议、接口分歧、数据格式问题，**一律以此文档为准**。  
   - 该文档是P0功能范围的**最终裁定**，未列入P0的内容**严禁擅自实现**。

2. **接口实操手册**：`接口实现 checklist 和 前后端 TODO 表.md`  （这个不用管）
   - 前端（D）和后端（A）每日开发时，必须对照此表的TODO项打勾完成。  
   - 接口的**请求方式、返回JSON结构、错误码**必须与此表100%一致。

3. **协作流程指南**：`分工计划c.md`  
   - 明确四人各自的职责边界、Git工作流、每日碰头会、联调机制。  
   - C将每日检查该计划的执行情况，未按要求提交PR或参加联调者，C有权**阻塞其代码合并**。

4. **开发时间轴**：`开发计划.md`  
   - 用于核对每日进度，若个人任务提前完成，必须**立即协助阻塞中的队友**，不得私自开始P1功能。

5. **`api.md`**（当前为空）  
   - 由A负责每日接口变更后**立即更新**，C会在**每天17:00**检查此文档与代码是否同步。  
   - 前端必须以`/docs/api.md`作为接口调用的**最终参考**，不得直接依赖后端口头说明。

---

## **二、必须遵守的硬性规范（违反者代码不予合并）**

### **1. 目录结构规范（严禁私自创建文件夹）**
```
project-root/
├── backend/
│   ├── main.py                 # FastAPI入口，A维护
│   ├── models/
│   │   └── best.onnx          # 模型文件，B维护
│   └── data/
│       ├── videos/{task_id}/video.mp4    # A负责写入，D只读
│       └── detections/{task_id}.json     # A负责写入，D只读
├── frontend/
│   ├── src/
│   │   ├── pages/
│   │   │   ├── UploadPage.jsx      # D负责
│   │   │   ├── InspectPage.jsx     # D负责（C实现HistoryPage跳转逻辑）
│   │   │   └── HistoryPage.jsx     # C负责，D不得修改
│   │   └── components/
│   │       ├── VideoPlayer.jsx     # D负责
│   │       ├── CanvasOverlay.jsx   # D负责
│   │       └── AnnotationPanel.jsx # D负责
│   └── package.json
├── docs/                       # C负责归总，A/D/B按需写入
│   ├── api.md                  # A每日更新，C每日检查
│   ├── ui-decisions.md         # C维护，记录团队UI评审结论
│   ├── risk-board.md           # C维护，每日更新风险状态
│   └── claude-prompts.md       # D维护，团队共享Prompt模板
├── railway.db                  # SQLite数据库，A管理
└── README.md                   # C最终整理
```
**红线**：任何人在`backend/data/`下**不得手动创建或删除**文件夹，必须通过接口自动化生成。私自改动目录结构导致联调失败，责任人会后必须**请全队喝奶茶**。

### **2. 接口契约铁律（A/D必须遵守）**
- **统一返回格式**：所有接口必须返回`{ "success": bool, "data": {...} }`或`{ "success": false, "error": "ERROR_CODE" }`。  
  - **HTTP状态码**：P0阶段**全部返回200**，错误信息放在JSON里，不得返回40x/50x HTML页面。
- **错误码必须使用P0最小集合**（见MVP文档“统一错误格式”章节）：
  - 通用：`INTERNAL_ERROR`
  - 上传：`UPLOAD_INVALID_FILE`, `UPLOAD_SAVE_FAILED`
  - 检测：`TASK_NOT_FOUND`, `DETECT_FAILED`, `DETECTIONS_NOT_FOUND`
  - 历史：`HISTORY_LOAD_FAILED`
  - **严禁自创错误码**，如需扩展必须在碰头会提出，C同意后才可添加。
- **接口幂等性**：`/detect/{task_id}`必须实现**幂等性检测**，JSON存在时直接返回`already_exists: true`，不得重复推理。A必须在代码中显式注释`# IDEMPOTENT CHECK`。
- **视频访问**：`/videos/{task_id}`必须使用`FileResponse`，且**必须支持HTTP Range请求**（video.js进度条依赖此功能）。

### **3. 命名与ID生成规范**
- **task_id**：必须由A按`local_` + 6-8位小写字母数字生成（如`local_f3a9c2`），**不得包含特殊字符**。前端禁止自行构造task_id。
- **box_id**：每帧内从1开始递增，**帧内唯一，全局不唯一**。D在绘制时不得假设box_id跨帧相同。
- **时间格式**：所有`created_at`字段必须使用**ISO8601字符串**（如`2025-11-16T10:00:00`），后端统一用Python的`datetime.isoformat()`生成，前端禁止自行格式化后传给后端。

### **4. Git协作红线**
- **分支策略**：`main`分支受保护，个人开发必须在`feature/{姓名}/{功能}`分支（如`feature/a/upload-api`）。
- **代码审查**：每天20:00由C组织PR审查，**未经C合并的代码不得进入main**。审查重点：
  - 是否包含`# SYNCED`标记（联调完成的接口必须加此注释）。
  - 是否修改了非自己负责的目录（如D改动了`backend/`）。
  - 是否删除了核心功能代码。
- **提交信息**：必须清晰，如`feat: 实现/upload接口`或`fix: 修复Canvas全屏错位`。C会每日抽查，信息模糊者打回重写。

---

## **三、开发特别注意事项（A/B/D各自重点）**

### **对A（后端架构师）的强制要求**
1. **接口文档同步**：每次修改接口后，**必须在30分钟内更新`/docs/api.md`**，并在碰头会告知C。C发现文档与代码不一致，有权**要求A停止新功能开发，先补文档**。
2. **数据库操作**：所有SQL必须带`IF NOT EXISTS`，避免重复建表报错。`tasks`表字段必须与MVP文档完全一致，**不得擅自添加P1字段**。
3. **错误处理**：每个接口必须有`try/except`捕获异常，日志打印traceback，但**返回给前端的错误信息必须脱敏**，不得暴露堆栈。
4. **性能兜底**：`/detections/{task_id}`返回的JSON可能很大（>10MB），必须使用**流式响应**或**分页加载**（P0可先不实现分页，但代码中要预留`# TODO: P1 PAGINATION`注释）。

### **对B（AI模型工程师）的强制要求**
1. **模型路径**：`best.onnx`必须放在`backend/models/`下，代码中加载路径写死为`models/best.onnx`，**不得硬编码绝对路径**。
2. **推理配置**：P0阶段**必须使用YOLO默认conf/iou**，代码中可以预留参数位，但**不得擅自调参**。如需实验，必须在P1阶段并记录日志。
3. **JSON格式**：生成的`detections.json`必须**严格符合MVP文档示例**，特别是：
   - `frame_index`从0开始，连续递增。
   - `time`字段精确到小数点后4位（如0.0333）。
   - `label`只能是`iron_pole`/`concrete_pole`/`iron_gantry_pole`，**不得出现其他字符串**。
4. **性能监控**：B必须在第3天结束前，向C提交**首份性能报告**（单帧推理耗时、GPU/CPU占用），若推理速度<5fps，必须立即提出风险。

### **对D（前端主程）的强制要求**
1. **Canvas同步精度**：`timeupdate`事件触发绘图时，必须**先清空画布再重绘**，避免残影。C会在第4天联调时用**慢动作录屏检查**，若发现框错位>50px，D必须当场修复。
2. **video.js配置**：播放器的`src`必须设为`/videos/{task_id}`，**不得直接读取本地文件**。全屏按钮必须保留，倍速至少支持1x/2x。
3. **标注按钮交互**：AnnotationPanel的“标注（演示）”按钮点击后，**必须调用`alert()`或显示临时文案**，不得留空。C会在第6天功能评审时逐一测试，无反馈的按钮视为未完成。
4. **Mock数据**：若B的推理延迟，D必须**使用MVP文档中的JSON示例作为Mock**，格式必须100%一致，严禁简化。

---

## **四、C的管理监督机制（所有成员必须配合）**

1. **每日碰头会（15分钟）**：  
   - 时间：每天20:00-20:15，由C组织，**迟到10分钟以上者需在群里发红包**。  
   - 内容：按`分工计划c.md`的模板同步进度，A/B/D必须带**代码截图或演示**。

2. **接口状态看板**：  
   - A每天17:00前更新接口实现状态（✅/🔲/❌），C在碰头会前检查。  
   - 若状态虚报（如标记✅但实际未联调），C有权**撤销该接口的代码合并**。

3. **风险看板**：  
   - 所有人发现风险必须**立即在群里@C**，C会更新`docs/risk-board.md`。  
   - 第7天风险未关闭，责任人需在总结会上**公开说明原因及改进措施**。

4. **代码审查重点**：  
   - C每日抽查`# SYNCED`标记，未标记的接口代码视为**未完成联调**，不得合并。  
   - C会检查Git提交记录，若出现`Merge branch 'main' into feature/xxx`等无效提交，打回重写。

5. **文档归总**：  
   - 第7天21:00后，所有人将各自负责的文档（A的部署文档、B的模型文档、D的用户手册）**压缩打包发给C**，由C统一归档到`/docs`并打tag。延迟提交者，C有权**在总结报告中标注“文档不达标”**。

---

## **五、紧急问题升级路径**

- **技术阻塞**：先找对口人（如Canvas问题D→B），10分钟内无法解决→**立即@C**，C协调资源或启动降级方案。  
- **接口争议**：A与D无法达成一致→**C依据MVP文档裁定**，双方必须服从。  
- **需求变更**：任何人不得私自接受需求变更，必须**由C在碰头会提出团队表决**，2人以上同意方可记录为P1。

---

**最后重申**：MVP需求文档是宪法，接口checklist是法律，分工计划是行政条例。C作为“立法监督者”，有权对违反上述规定的代码**一票否决**。请各位每日开发前，**务必通读当日任务对应的文档章节**，避免返工。